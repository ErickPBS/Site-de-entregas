<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>App Delivery – Dashboard do Entregador</title>
  <link rel="stylesheet" href="/static/style.css" />
  <link rel="stylesheet" href="../static/style.css" />
  <script src="/static/js/nav.js" defer></script>
  <style>
    .dash-container { max-width: 1120px; margin: 0 auto; }
    .kpis { display: grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap: 12px; margin: 16px 0; }
    .kpi { background:#fff; border-radius:10px; padding:14px; box-shadow:0 1px 8px rgba(0,0,0,.06); }
    .kpi h3 { margin:0 0 6px 0; font-size:14px; color:#6b7280; font-weight:600; }
    .kpi .value { font-size:26px; font-weight:700; }
    .cards { display:grid; grid-template-columns: repeat(auto-fit,minmax(320px,1fr)); gap:16px; }
    .card-block { background:#fff; border-radius:10px; padding:16px; box-shadow:0 1px 8px rgba(0,0,0,.06); }
    .card-block h2 { margin:0 0 8px 0; font-size:18px; }
    canvas { width:100%; height:260px; display:block; }
    .legend { display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }
    .legend span { display:inline-flex; align-items:center; gap:6px; font-size:12px; color:#6b7280; }
    .dot { width:10px; height:10px; border-radius:50%; display:inline-block; }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand" style="color:#ff3d3d">Entregador</div>
      <nav>
        <a href="/Templates/delivery_panel.html">Corridas</a>
        <hr />
        <a href="/logout">Sair</a>
      </nav>
    </aside>
    <main class="content">
      <div class="dash-container">
        <h1 style="margin:0 0 12px 0;">Resumo</h1>
        <div class="kpis">
          <div class="kpi"><h3>Entregas hoje</h3><div class="value" id="kpi-entregas">0</div></div>
          <div class="kpi"><h3>Km rodados</h3><div class="value" id="kpi-km">0,0</div></div>
          <div class="kpi"><h3>Avaliação média</h3><div class="value" id="kpi-rating">0,0</div></div>
          <div class="kpi"><h3>Ganho hoje</h3><div class="value" id="kpi-ganho">R$ 0,00</div></div>
        </div>
        <div class="cards">
          <div class="card-block"><h2>Entregas por hora</h2><canvas id="chart-horas"></canvas></div>
          <div class="card-block"><h2>Distância por corrida</h2><canvas id="chart-dist"></canvas><div class="legend" id="legend-dist"></div></div>
          <div class="card-block"><h2>Ganhos por hora</h2><canvas id="chart-ganhos"></canvas></div>
          <div class="card-block"><h2>Status das corridas</h2><canvas id="chart-status"></canvas><div class="legend" id="legend-status"></div></div>
        </div>
      </div>
    </main>
  </div>

  <script>
    function drawBarChart(canvas, labels, values, color){
      const dpr = window.devicePixelRatio || 1;
      const width = canvas.clientWidth, height = canvas.clientHeight;
      canvas.width = width * dpr; canvas.height = height * dpr;
      const ctx = canvas.getContext('2d'); ctx.scale(dpr,dpr);
      ctx.clearRect(0,0,width,height);
      const max = Math.max(1, ...values);
      const padL=30, padB=24, padT=10, padR=10;
      const w = width - padL - padR, h = height - padT - padB;
      const bw = w / values.length * 0.6;
      ctx.strokeStyle = '#eee'; ctx.lineWidth = 1;
      for(let i=0;i<=4;i++){
        const y = padT + h * i/4; ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(width-padR,y); ctx.stroke();
      }
      ctx.fillStyle = color;
      values.forEach((v,i)=>{
        const x = padL + (w/values.length)*i + (w/values.length-bw)/2;
        const bh = (v/max)*h; const y = padT + h - bh;
        ctx.fillRect(x,y,bw,bh);
      });
      ctx.fillStyle = '#6b7280'; ctx.font = '12px sans-serif'; ctx.textAlign='center';
      labels.forEach((l,i)=>{ const x = padL + (w/values.length)*i + (w/values.length)/2; ctx.fillText(l,x,height-8); });
    }

    function drawDonut(canvas, segments){
      const dpr = window.devicePixelRatio || 1;
      const width = canvas.clientWidth, height = canvas.clientHeight;
      canvas.width = width * dpr; canvas.height = height * dpr;
      const ctx = canvas.getContext('2d'); ctx.scale(dpr,dpr);
      const cx = width/2, cy = height/2, r = Math.min(width,height)/2 - 8; const inner = r*0.6;
      const total = segments.reduce((a,s)=>a+s.value,0) || 1;
      let start = -Math.PI/2;
      segments.forEach(s=>{ const ang = (s.value/total)*Math.PI*2; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.fillStyle=s.color; ctx.arc(cx,cy,r,start,start+ang); ctx.closePath(); ctx.fill(); start += ang; });
      ctx.globalCompositeOperation='destination-out'; ctx.beginPath(); ctx.arc(cx,cy,inner,0,Math.PI*2); ctx.fill(); ctx.globalCompositeOperation='source-over';
    }

    function legend(el, seg){ el.innerHTML = seg.map(s=>`<span><i class="dot" style="background:${s.color}"></i>${s.label}</span>`).join(''); }

    function render(metrics){
      document.getElementById('kpi-entregas').textContent = metrics.entregasHoje;
      document.getElementById('kpi-km').textContent = metrics.kmHoje.toFixed(1).replace('.', ',');
      document.getElementById('kpi-rating').textContent = metrics.rating.toFixed(1).replace('.', ',');
      document.getElementById('kpi-ganho').textContent = 'R$ ' + metrics.ganhoHoje.toFixed(2).replace('.', ',');

      drawBarChart(document.getElementById('chart-horas'), metrics.horas, metrics.entregasPorHora, '#3b82f6');
      drawBarChart(document.getElementById('chart-ganhos'), metrics.horas, metrics.ganhosPorHora, '#10b981');
      drawDonut(document.getElementById('chart-dist'), metrics.distSeg);
      legend(document.getElementById('legend-dist'), metrics.distSeg);
      drawDonut(document.getElementById('chart-status'), metrics.statusSeg);
      legend(document.getElementById('legend-status'), metrics.statusSeg);
    }

    function load(){
      // Sem API ainda: dados exemplo
      const labels = ['10h','11h','12h','13h','14h','15h','16h','17h'];
      const entregas = [0,1,2,1,1,1,0,1];
      const ganhos = entregas.map(v => v*7.5 + (v?5:0));
      const totalEnt = entregas.reduce((a,b)=>a+b,0);
      const km = 18.3, rating = 4.8;
      const ganhoHoje = ganhos.reduce((a,b)=>a+b,0);
      const distSeg = [
        {label:'Curtas', value: 5, color:'#3b82f6'},
        {label:'Médias', value: 3, color:'#f59e0b'},
        {label:'Longas', value: 2, color:'#10b981'},
      ];
      const statusSeg = [
        {label:'Aceitas', value: 3, color:'#3b82f6'},
        {label:'Em rota', value: 2, color:'#f59e0b'},
        {label:'Concluídas', value: 5, color:'#10b981'},
      ];
      render({ horas: labels, entregasPorHora: entregas, ganhosPorHora: ganhos, entregasHoje: totalEnt, kmHoje: km, rating: rating, ganhoHoje, distSeg, statusSeg });
    }

    window.addEventListener('load', load);
    window.addEventListener('resize', load);
  </script>
</body>
</html>
