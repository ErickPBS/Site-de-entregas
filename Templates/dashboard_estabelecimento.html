
<!doctype html>
<html lang="pt-BR">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>App Delivery – Dashboard do Estabelecimento</title>
  <link rel="stylesheet" href="/static/style.css" />
  <script src="/static/js/nav.js" defer></script>
  <style>
    .dash-container { max-width: 1120px; margin: 0 auto; }
    .kpis { display: grid; grid-template-columns: repeat(auto-fit,minmax(220px,1fr)); gap: 12px; margin: 16px 0; }
    .kpi { background:#fff; border-radius:10px; padding:14px; box-shadow:0 1px 8px rgba(0,0,0,.06); }
    .kpi h3 { margin:0 0 6px 0; font-size:14px; color:#6b7280; font-weight:600; }
    .kpi .value { font-size:26px; font-weight:700; }
    .cards { display:grid; grid-template-columns: repeat(auto-fit,minmax(320px,1fr)); gap:16px; }
    .card-block { background:#fff; border-radius:10px; padding:16px; box-shadow:0 1px 8px rgba(0,0,0,.06); }
    .card-block h2 { margin:0 0 8px 0; font-size:18px; }
    canvas { width:100%; height:260px; display:block; }
    .legend { display:flex; gap:10px; flex-wrap:wrap; margin-top:8px; }
    .legend span { display:inline-flex; align-items:center; gap:6px; font-size:12px; color:#6b7280; }
    .dot { width:10px; height:10px; border-radius:50%; display:inline-block; }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="brand" style="color:#ff3d3d">Estabelecimento</div>
      <nav>
        <a href="/Templates/dashboard_estabelecimento.html">Dashboard</a>
        <a href="/painel">Pedidos</a>
        <a href="/Templates/cadastro.html">Cadastro</a>
        <hr />
        <a href="/logout">Sair</a>
      </nav>
    </aside>
    <main class="content">
      <div class="dash-container">
        <h1 style="margin:0 0 12px 0;">Resumo</h1>
        <div class="kpis">
          <div class="kpi"><h3>Pedidos hoje</h3><div class="value" id="kpi-pedidos">24</div></div>
          <div class="kpi"><h3>Tempo médio</h3><div class="value" id="kpi-tempo">28 min</div></div>
          <div class="kpi"><h3>Avaliação média</h3><div class="value" id="kpi-rating">4.6</div></div>
          <div class="kpi"><h3>Ticket médio</h3><div class="value" id="kpi-ticket">R$ 42,30</div></div>
          <div class="kpi"><h3>Receita do dia</h3><div class="value" id="kpi-receita">R$ 0,00</div></div>
        </div>
        <div class="cards">
          <div class="card-block"><h2>Pedidos por hora</h2><canvas id="chart-horas"></canvas></div>
          <div class="card-block"><h2>Mix de categorias</h2><canvas id="chart-mix"></canvas><div class="legend" id="legend-mix"></div></div>
          <div class="card-block"><h2>Receita por categoria</h2><ul id="mix-list" style="list-style:none;padding-left:0;margin:0;color:#374151"></ul></div>
          <div class="card-block"><h2>Pedidos por status</h2><canvas id="chart-status"></canvas><div class="legend" id="legend-status"></div></div>
        </div>
      </div>
    </main>
  </div>

  <script>
    function drawBarChart(canvas, labels, values, color){
      const dpr = window.devicePixelRatio || 1;
      const width = canvas.clientWidth, height = canvas.clientHeight;
      canvas.width = width * dpr; canvas.height = height * dpr;
      const ctx = canvas.getContext('2d'); ctx.scale(dpr,dpr);
      ctx.clearRect(0,0,width,height);
      const max = Math.max(1, ...values);
      const padL=30, padB=24, padT=10, padR=10;
      const w = width - padL - padR, h = height - padT - padB;
      const bw = w / values.length * 0.6;
      ctx.strokeStyle = '#eee'; ctx.lineWidth = 1;
      for(let i=0;i<=4;i++){
        const y = padT + h * i/4; ctx.beginPath(); ctx.moveTo(padL,y); ctx.lineTo(width-padR,y); ctx.stroke();
      }
      ctx.fillStyle = color;
      values.forEach((v,i)=>{
        const x = padL + (w/values.length)*i + (w/values.length-bw)/2;
        const bh = (v/max)*h; const y = padT + h - bh;
        ctx.fillRect(x,y,bw,bh);
      });
      ctx.fillStyle = '#6b7280'; ctx.font = '12px sans-serif'; ctx.textAlign='center';
      labels.forEach((l,i)=>{ const x = padL + (w/values.length)*i + (w/values.length)/2; ctx.fillText(l,x,height-8); });
    }

    function drawDonut(canvas, segments){
      const dpr = window.devicePixelRatio || 1;
      const width = canvas.clientWidth, height = canvas.clientHeight;
      canvas.width = width * dpr; canvas.height = height * dpr;
      const ctx = canvas.getContext('2d'); ctx.scale(dpr,dpr);
      const cx = width/2, cy = height/2, r = Math.min(width,height)/2 - 8; const inner = r*0.6;
      const total = segments.reduce((a,s)=>a+s.value,0) || 1;
      let start = -Math.PI/2;
      segments.forEach(s=>{
        const ang = (s.value/total)*Math.PI*2; ctx.beginPath(); ctx.moveTo(cx,cy); ctx.fillStyle=s.color; ctx.arc(cx,cy,r,start,start+ang); ctx.closePath(); ctx.fill(); start += ang; });
      ctx.globalCompositeOperation='destination-out'; ctx.beginPath(); ctx.arc(cx,cy,inner,0,Math.PI*2); ctx.fill(); ctx.globalCompositeOperation='source-over';
    }

    function renderLegend(el, segments){
      el.innerHTML = segments.map(s=>`<span><i class="dot" style="background:${s.color}"></i>${s.label}</span>`).join('');
    }

    const colorBar = '#ff3d3d';
    function render(metrics){
      document.getElementById('kpi-pedidos').textContent = metrics.pedidosHoje;
      document.getElementById('kpi-tempo').textContent = metrics.tempoMedioMin + ' min';
      document.getElementById('kpi-rating').textContent = metrics.avaliacaoMedia;
      document.getElementById('kpi-ticket').textContent = 'R$ ' + metrics.ticketMedio.toFixed(2).replace('.', ',');
      document.getElementById('kpi-receita').textContent = 'R$ ' + (metrics.receitaHoje||0).toFixed(2).replace('.', ',');
      drawBarChart(document.getElementById('chart-horas'), metrics.horas, metrics.pedidosPorHora, colorBar);
      drawDonut(document.getElementById('chart-mix'), metrics.mix);
      renderLegend(document.getElementById('legend-mix'), metrics.mix);
      const statusSeg = (metrics.statusLabels||[]).map((lab, i)=>({label: lab, value: metrics.statusValues[i]||0, color: ['#f59e0b','#3b82f6','#10b981'][i%3]}));
      drawDonut(document.getElementById('chart-status'), statusSeg);
      renderLegend(document.getElementById('legend-status'), statusSeg);

      const ul = document.getElementById('mix-list');
      if (ul) {
        const total = (metrics.receitaHoje||0) || 1;
        ul.innerHTML = (metrics.mix||[]).map(m => {
          const pct = total ? Math.round((m.amount||0) / total * 100) : 0;
          return `<li style="padding:6px 0;border-bottom:1px solid #f3f4f6;display:flex;justify-content:space-between;">
            <span><i class="dot" style="background:${m.color};margin-right:6px"></i>${m.label}</span>
            <span>R$ ${(m.amount||0).toFixed(2).replace('.', ',')} (${pct}%)</span>
          </li>`
        }).join('');
      }
    }

    function fetchAndRender(){
      fetch('/api/estab/metrics')
        .then(r=>r.json())
        .then(render)
        .catch(()=>{
          render({
            pedidosHoje: 24, tempoMedioMin: 28, avaliacaoMedia: 4.6, ticketMedio: 42.3,
            horas: ['10h','11h','12h','13h','14h','15h','16h','17h'], pedidosPorHora: [3,5,9,7,6,8,4,2],
            mix: [
              {label:'Burgers', value:42, color:'#ff3d3d'},
              {label:'Pizzas', value:28, color:'#f59e0b'},
              {label:'Sushi', value:17, color:'#10b981'},
              {label:'Saladas', value:13, color:'#3b82f6'}
            ],
            statusLabels:['Aguardando','Preparando','Pronto'],
            statusValues:[8,10,6],
            receitaHoje: 1012.5
          });
        });
    }

    window.addEventListener('load', fetchAndRender);
    window.addEventListener('resize', fetchAndRender);
  </script>
</body>
</html>
